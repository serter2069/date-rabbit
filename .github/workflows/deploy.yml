name: Deploy

on:
  push:
    branches: [main, development]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build frontend (Expo web)
        run: |
          cd app
          npm ci --legacy-peer-deps
          npx expo export --platform web
          mkdir -p dist/version
          cat > dist/version.json << VEOF
          {
            "version": "$(git rev-parse --short HEAD)",
            "commit": "$(git rev-parse HEAD)",
            "branch": "${{ github.ref_name }}",
            "deployed": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "message": "$(git log -1 --pretty=%s | head -c 100)"
          }
          VEOF

      - name: Build backend (NestJS)
        run: |
          cd backend/daterabbit-api
          npm ci
          npm run build

      - name: Deploy frontend
        run: |
          rsync -rlD --delete \
            --exclude 'api' \
            --exclude 'uploads' \
            app/dist/ /var/www/daterabbit/

      - name: Create backend .env if missing
        run: |
          if [ ! -f /var/www/daterabbit/api/.env ]; then
            cat > /var/www/daterabbit/api/.env << 'ENVEOF'
          PORT=3004
          NODE_ENV=development
          DEV_AUTH=true
          DB_HOST=localhost
          DB_PORT=5432
          DB_USERNAME=daterabbit
          DB_PASSWORD=daterabbit
          DB_NAME=daterabbit
          JWT_SECRET=daterabbit-dev-jwt-secret-change-in-prod
          ENVEOF
            echo ".env created with defaults"
          else
            echo ".env already exists"
          fi

      - name: Setup database (if needed)
        continue-on-error: true
        run: |
          sudo -u postgres psql -tc "SELECT 1 FROM pg_roles WHERE rolname='daterabbit'" | grep -q 1 || \
            sudo -u postgres psql -c "CREATE USER daterabbit WITH PASSWORD 'daterabbit';"
          sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname='daterabbit'" | grep -q 1 || \
            sudo -u postgres psql -c "CREATE DATABASE daterabbit OWNER daterabbit;"
          sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE daterabbit TO daterabbit;" 2>/dev/null || true
          echo "Database ready"

      - name: Deploy backend
        run: |
          rsync -rlD --delete \
            --exclude 'node_modules' \
            --exclude '.env' \
            --exclude 'dist' \
            backend/daterabbit-api/ /var/www/daterabbit/api/
          rsync -rlD backend/daterabbit-api/dist/ /var/www/daterabbit/api/dist/
          cd /var/www/daterabbit/api
          npm ci --production

      - name: Restart backend
        run: |
          cd /var/www/daterabbit/api
          sudo pm2 restart daterabbit || sudo pm2 start dist/main.js --name daterabbit
          sudo chown -R www-data:www-data /var/www/daterabbit/

      - name: Verify deployment
        run: |
          sleep 5
          echo "=== version.json ==="
          cat /var/www/daterabbit/version.json
          echo "=== PM2 status ==="
          sudo pm2 show daterabbit | grep -E "(status|restarts|uptime)"
          echo "=== Backend .env ==="
          test -f /var/www/daterabbit/api/.env && echo ".env EXISTS" || echo ".env MISSING"
          echo "=== PM2 error logs (last 10) ==="
          sudo pm2 logs daterabbit --nostream --lines 10 --err 2>&1 || true
