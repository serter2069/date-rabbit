name: Deploy

on:
  push:
    branches: [main, development]
  workflow_dispatch:
    inputs:
      seed:
        description: 'Run seed script after deploy? Type "yes"'
        required: false
        default: ''

jobs:
  deploy-staging:
    name: Deploy → Staging
    if: github.ref == 'refs/heads/development'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build frontend (Expo web)
        run: |
          cd app
          npm ci --legacy-peer-deps
          npx expo export --platform web
          cat > dist/version.json << VEOF
          {
            "version": "$(git rev-parse --short HEAD)",
            "commit": "$(git rev-parse HEAD)",
            "branch": "${{ github.ref_name }}",
            "deployed": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "message": "$(git log -1 --pretty=%s | head -c 100)"
          }
          VEOF

      - name: Build backend (NestJS)
        run: |
          cd backend/daterabbit-api
          npm ci
          npm run build

      - name: Deploy frontend
        run: |
          rsync -rlD --delete \
            --exclude 'api' \
            --exclude 'uploads' \
            app/dist/ /var/www/daterabbit/

      - name: Create backend .env if missing
        run: |
          mkdir -p /var/www/daterabbit/api
          if [ ! -f /var/www/daterabbit/api/.env ]; then
            cat > /var/www/daterabbit/api/.env << 'ENVEOF'
          PORT=3004
          NODE_ENV=development
          DEV_AUTH=true
          DB_HOST=localhost
          DB_PORT=5432
          DB_USERNAME=daterabbit
          DB_PASSWORD=daterabbit
          DB_NAME=daterabbit
          JWT_SECRET=daterabbit-dev-jwt-secret-change-in-prod
          STRIPE_SECRET_KEY=
          STRIPE_WEBHOOK_SECRET=
          APP_URL=https://daterabbit.smartlaunchhub.com
          ENVEOF
            echo ".env created with defaults (add Stripe keys manually!)"
          else
            echo ".env already exists"
          fi

      - name: Deploy backend
        run: |
          rsync -rlD --delete \
            --exclude 'node_modules' \
            --exclude '.env' \
            --exclude 'dist' \
            --exclude 'uploads' \
            backend/daterabbit-api/ /var/www/daterabbit/api/
          rsync -rlD backend/daterabbit-api/dist/ /var/www/daterabbit/api/dist/
          cd /var/www/daterabbit/api
          npm ci --production

      - name: Update Stripe env vars
        env:
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
        run: |
          ENV_FILE="/var/www/daterabbit/api/.env"
          if [ -f "$ENV_FILE" ]; then
            # Update STRIPE_SECRET_KEY
            if grep -q "^STRIPE_SECRET_KEY=" "$ENV_FILE"; then
              sed -i "s|^STRIPE_SECRET_KEY=.*|STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}|" "$ENV_FILE"
            else
              echo "STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}" >> "$ENV_FILE"
            fi
            # Update STRIPE_WEBHOOK_SECRET
            if grep -q "^STRIPE_WEBHOOK_SECRET=" "$ENV_FILE"; then
              sed -i "s|^STRIPE_WEBHOOK_SECRET=.*|STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}|" "$ENV_FILE"
            else
              echo "STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}" >> "$ENV_FILE"
            fi
            echo "Stripe env vars updated"
          else
            echo "ERROR: .env not found at $ENV_FILE"
            exit 1
          fi

      - name: Restart backend
        run: |
          cd /var/www/daterabbit/api
          sudo pm2 restart daterabbit || sudo pm2 start dist/main.js --name daterabbit
          sudo chown -R www-data:www-data /var/www/daterabbit/

      - name: Ensure nginx API proxy
        continue-on-error: true
        run: |
          CONF="/etc/nginx/sites-available/daterabbit"
          # Write complete nginx config using sudo tee (idempotent, runs every deploy)
          # This replaces the lost/reset config file with the correct one including /api/ proxy
          sudo chown $(whoami) "$CONF" 2>/dev/null || sudo touch "$CONF" && sudo chown $(whoami) "$CONF"
          sudo chmod 644 "$CONF"
          cat > "$CONF" << 'NGINXEOF'
server {
    server_name daterabbit.smartlaunchhub.com;

    root /var/www/daterabbit;
    index index.html;

    # API proxy to NestJS backend
    location /api/ {
        proxy_pass http://127.0.0.1:3004;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        client_max_body_size 10m;
    }

    location /uploads/ {
        alias /var/www/daterabbit/api/uploads/;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /_expo {
        alias /var/www/daterabbit/_expo;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml text/javascript;

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/daterabbit.smartlaunchhub.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/daterabbit.smartlaunchhub.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

server {
    if ($host = daterabbit.smartlaunchhub.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80;
    server_name daterabbit.smartlaunchhub.com;
    return 404; # managed by Certbot
}
NGINXEOF
          sudo chown root:root "$CONF"
          sudo chmod 644 "$CONF"
          # Ensure symlink in sites-enabled exists
          sudo ln -sf "$CONF" /etc/nginx/sites-enabled/daterabbit
          echo "=== Wrote nginx config ==="
          grep -n "proxy_pass\|listen\|server_name\|location /api" "$CONF" || true
          # Reload nginx
          if sudo nginx -t 2>&1; then
            sudo systemctl reload nginx && echo "Nginx reloaded successfully"
          else
            echo "nginx -t failed, trying graceful reload..."
            sudo nginx -s reload 2>&1 || sudo systemctl reload nginx 2>&1 || echo "Reload failed"
          fi
          sleep 2
          echo "--- Direct backend test ---"
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:3004/api/auth/start -H 'Content-Type: application/json' -d '{"email":"test@t.com"}' 2>/dev/null)
          echo "Direct backend: $HTTP"
          echo "--- Local nginx 443 test ---"
          HTTP443=$(curl -sk -o /dev/null -w "%{http_code}" -X POST https://localhost/api/auth/start -H 'Content-Type: application/json' -H 'Host: daterabbit.smartlaunchhub.com' -d '{"email":"test@t.com"}' 2>/dev/null)
          echo "Local nginx 443: $HTTP443"

      - name: Verify deployment
        if: always()
        run: |
          sleep 5
          echo "=== version.json ==="
          cat /var/www/daterabbit/version.json 2>&1 || echo "no version.json"
          echo "=== PM2 status ==="
          sudo pm2 show daterabbit 2>&1 | grep -E "(status|restarts|uptime)" || true
          echo "=== PM2 error logs (last 5) ==="
          sudo pm2 logs daterabbit --nostream --lines 5 --err 2>&1 || true
          echo "=== API smoke test (direct port) ==="
          curl -s -o /dev/null -w "GET /api/payments/earnings: %{http_code}\n" http://localhost:3004/api/payments/earnings || true
          curl -s -o /dev/null -w "POST /api/webhooks/stripe: %{http_code}\n" -X POST http://localhost:3004/api/webhooks/stripe || true
          echo "=== API smoke test (via nginx) ==="
          curl -s -o /dev/null -w "POST /api/auth/start via nginx: %{http_code}\n" -X POST https://daterabbit.smartlaunchhub.com/api/auth/start -H 'Content-Type: application/json' -d '{"email":"smoke@test.com"}' || true

      - name: Run seed script
        if: github.event.inputs.seed == 'yes'
        run: |
          cp /var/www/daterabbit/api/.env backend/daterabbit-api/.env
          cd backend/daterabbit-api
          npx ts-node src/seed/seed.ts 2>&1

  deploy-production:
    name: Deploy → Production
    if: github.ref == 'refs/heads/main'
    runs-on: self-hosted
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build frontend (Expo web)
        run: |
          cd app
          npm ci --legacy-peer-deps
          npx expo export --platform web
          cat > dist/version.json << VEOF
          {
            "version": "$(git rev-parse --short HEAD)",
            "commit": "$(git rev-parse HEAD)",
            "branch": "${{ github.ref_name }}",
            "deployed": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "message": "$(git log -1 --pretty=%s | head -c 100)"
          }
          VEOF

      - name: Build backend (NestJS)
        run: |
          cd backend/daterabbit-api
          npm ci
          npm run build

      - name: Deploy frontend
        run: |
          rsync -rlD --delete \
            --exclude 'api' \
            --exclude 'uploads' \
            app/dist/ /var/www/daterabbit/

      - name: Create backend .env if missing
        run: |
          if [ ! -f /var/www/daterabbit/api/.env ]; then
            echo "ERROR: Production .env must be pre-configured!"
            exit 1
          fi

      - name: Deploy backend
        run: |
          rsync -rlD --delete \
            --exclude 'node_modules' \
            --exclude '.env' \
            --exclude 'dist' \
            --exclude 'uploads' \
            backend/daterabbit-api/ /var/www/daterabbit/api/
          rsync -rlD backend/daterabbit-api/dist/ /var/www/daterabbit/api/dist/
          cd /var/www/daterabbit/api
          npm ci --production

      - name: Update Stripe env vars
        env:
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
        run: |
          ENV_FILE="/var/www/daterabbit/api/.env"
          if [ -f "$ENV_FILE" ]; then
            if grep -q "^STRIPE_SECRET_KEY=" "$ENV_FILE"; then
              sed -i "s|^STRIPE_SECRET_KEY=.*|STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}|" "$ENV_FILE"
            else
              echo "STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}" >> "$ENV_FILE"
            fi
            if grep -q "^STRIPE_WEBHOOK_SECRET=" "$ENV_FILE"; then
              sed -i "s|^STRIPE_WEBHOOK_SECRET=.*|STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}|" "$ENV_FILE"
            else
              echo "STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}" >> "$ENV_FILE"
            fi
            echo "Stripe env vars updated"
          else
            echo "ERROR: .env not found at $ENV_FILE"
            exit 1
          fi

      - name: Restart backend
        run: |
          cd /var/www/daterabbit/api
          sudo pm2 restart daterabbit || sudo pm2 start dist/main.js --name daterabbit
          sudo chown -R www-data:www-data /var/www/daterabbit/

      - name: Ensure nginx API proxy
        continue-on-error: true
        run: |
          # Write complete nginx config on EVERY deploy (idempotent fix)
          sudo bash server/write-nginx-config.sh
          sudo ln -sf /etc/nginx/sites-available/daterabbit /etc/nginx/sites-enabled/daterabbit
          grep -n "proxy_pass\|listen\|location /api\|server_name" /etc/nginx/sites-available/daterabbit || true
          if sudo nginx -t 2>&1; then
            sudo systemctl reload nginx && echo "Nginx reloaded successfully"
          else
            echo "nginx -t failed, trying graceful reload..."
            sudo nginx -s reload 2>&1 || sudo systemctl reload nginx 2>&1 || echo "Reload failed"
          fi

      - name: Verify deployment
        if: always()
        run: |
          sleep 5
          echo "=== version.json ==="
          cat /var/www/daterabbit/version.json 2>&1 || echo "no version.json"
          echo "=== PM2 status ==="
          sudo pm2 show daterabbit 2>&1 | grep -E "(status|restarts|uptime)" || true
          echo "=== PM2 error logs (last 5) ==="
          sudo pm2 logs daterabbit --nostream --lines 5 --err 2>&1 || true
          echo "=== API smoke test ==="
          curl -s -o /dev/null -w "GET /api/payments/earnings: %{http_code}\n" http://localhost:3004/api/payments/earnings || true
